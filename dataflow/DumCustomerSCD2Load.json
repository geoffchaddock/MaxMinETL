{
	"name": "DumCustomerSCD2Load",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "CustomersDS",
						"type": "DatasetReference"
					},
					"name": "Customers",
					"description": " Source employees file, changes every day"
				},
				{
					"dataset": {
						"referenceName": "DimCustomersDS",
						"type": "DatasetReference"
					},
					"name": "DimCustomers",
					"description": "Current rows in DimEmployees DW table"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DimCustomersDS",
						"type": "DatasetReference"
					},
					"name": "InsertNewRow"
				},
				{
					"dataset": {
						"referenceName": "DimCustomersDS",
						"type": "DatasetReference"
					},
					"name": "ArchiveOldRow"
				},
				{
					"dataset": {
						"referenceName": "DimCustomersDS",
						"type": "DatasetReference"
					},
					"name": "InsertNewRecs",
					"rejectedDataLinkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					}
				}
			],
			"transformations": [
				{
					"name": "TypeConversions"
				},
				{
					"name": "TypeConversionsAndSetAttrs"
				},
				{
					"name": "LookupIDs"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "checkForChanges"
				},
				{
					"name": "SetAttrsForNew"
				},
				{
					"name": "SetAttrsInactive",
					"description": "make iscurrent 0"
				},
				{
					"name": "SetAttrsUpdate"
				},
				{
					"name": "NormNames"
				},
				{
					"name": "InactiveFields"
				},
				{
					"name": "ArchiveCustomerRec"
				},
				{
					"name": "NullFilter",
					"description": "Filter out NULLs from source file"
				},
				{
					"name": "NameNorm2"
				},
				{
					"name": "filterOnlyActiveRows"
				}
			],
			"scriptLines": [
				"source(output(",
				"          AccountNumber as integer,",
				"          FirstName as string,",
				"          MiddleInitial as string,",
				"          LastName as string,",
				"          Address as string,",
				"          City as string,",
				"          State as string,",
				"          ZipCode as string,",
				"          NumberOfCarsOwned as integer,",
				"          HomeOwnerFlag as string,",
				"          Married as string,",
				"          NumberOfChildren as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> Customers",
				"source(output(",
				"          CustomerPK as integer,",
				"          AccountNumber as integer,",
				"          FirstName as string,",
				"          MiddleInitial as string,",
				"          LastName as string,",
				"          Address as string,",
				"          City as string,",
				"          State as string,",
				"          ZipCode as string,",
				"          NumberOfCarsOwned as integer,",
				"          HomeOwnerFlag as string,",
				"          Married as string,",
				"          NumberOfChildren as integer,",
				"          InsertedDate as timestamp,",
				"          UpdatedDate as timestamp,",
				"          ActiveFlag as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table',",
				"     staged: true) ~> DimCustomers",
				"DimCustomers derive(AccountNumber = toInteger(AccountNumber),",
				"          CustomerPK = toInteger(CustomerPK)) ~> TypeConversions",
				"NullFilter derive(AccountNumber = toInteger(AccountNumber),",
				"          NumberOfCarsOwned = toInteger(NumberOfCarsOwned),",
				"          NumberOfChildren = toInteger(NumberOfChildren)) ~> TypeConversionsAndSetAttrs",
				"TypeConversionsAndSetAttrs, filterOnlyActiveRows lookup(TypeConversionsAndSetAttrs@AccountNumber == TypeConversions@AccountNumber,",
				"     multiple: true,",
				"     broadcast: 'auto')~> LookupIDs",
				"NormNames split(isNull(iscurrent),",
				"     disjoint: false) ~> ConditionalSplit1@(NewRow, CheckForUpdates)",
				"NameNorm2, filterOnlyActiveRows exists(MiddleName(toInteger(NameNorm2@AccountNumber) == toInteger(filterOnlyActiveRows@AccountNumber)) && \r",
				"(ActiveFlag == 1) &&\r",
				"(\r",
				"   (NameNorm2@NumberOfCarsOwned != DimCustomers@NumberOfCarsOwned) || \r",
				"   (NameNorm2@NumberOfChildren != DimCustomers@NumberOfChildren) ||\r",
				"   (NameNorm2@Married != DimCustomers@Married) || \r",
				"   (NameNorm2@Address != DimCustomers@Address)\r",
				"),",
				"     negate:false,",
				"     broadcast: 'auto')~> checkForChanges",
				"ConditionalSplit1@NewRow derive(iscurrent = 1,",
				"          InsertedDate = currentTimestamp()) ~> SetAttrsForNew",
				"checkForChanges derive(iscurrent = 0,",
				"          UpdatedDate = currentTimestamp()) ~> SetAttrsInactive",
				"checkForChanges derive(iscurrent = 1) ~> SetAttrsUpdate",
				"LookupIDs select(mapColumn(",
				"          AccountNumber = TypeConversionsAndSetAttrs@AccountNumber,",
				"          FirstName = Customers@FirstName,",
				"          MiddleName = Customers@MiddleInitial,",
				"          LastName = Customers@LastName,",
				"          Address = Customers@Address,",
				"          City = Customers@City,",
				"          State = Customers@State,",
				"          ZipCode = Customers@ZipCode,",
				"          NumberOfCarsOwned = TypeConversionsAndSetAttrs@NumberOfCarsOwned,",
				"          HomeOwnerFlag = Customers@HomeOwnerFlag,",
				"          NumberOfChildren = TypeConversionsAndSetAttrs@NumberOfChildren,",
				"          Married = DimCustomers@Married,",
				"          iscurrent = ActiveFlag,",
				"          InsertedDate",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> NormNames",
				"SetAttrsInactive select(mapColumn(",
				"          AccountNumber,",
				"          iscurrent,",
				"          UpdatedDate",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> InactiveFields",
				"InactiveFields alterRow(updateIf(true())) ~> ArchiveCustomerRec",
				"Customers filter(!isNull(AccountNumber)) ~> NullFilter",
				"ConditionalSplit1@CheckForUpdates select(mapColumn(",
				"          AccountNumber,",
				"          FirstName,",
				"          MiddleName,",
				"          LastName,",
				"          Address,",
				"          City,",
				"          State,",
				"          ZipCode,",
				"          NumberOfCarsOwned,",
				"          HomeOwnerFlag,",
				"          NumberOfChildren,",
				"          Married,",
				"          iscurrent,",
				"          InsertedDate",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> NameNorm2",
				"TypeConversions filter(ActiveFlag == 1) ~> filterOnlyActiveRows",
				"SetAttrsUpdate sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CustomerPK as integer,",
				"          AccountNumber as integer,",
				"          FirstName as string,",
				"          MiddleInitial as string,",
				"          LastName as string,",
				"          Address as string,",
				"          City as string,",
				"          State as string,",
				"          ZipCode as string,",
				"          NumberOfCarsOwned as integer,",
				"          HomeOwnerFlag as string,",
				"          Married as string,",
				"          NumberOfChildren as integer,",
				"          InsertedDate as timestamp,",
				"          UpdatedDate as timestamp,",
				"          ActiveFlag as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     staged: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 3,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          AccountNumber,",
				"          FirstName,",
				"          MiddleInitial = MiddleName,",
				"          LastName,",
				"          Address,",
				"          City,",
				"          State,",
				"          ZipCode,",
				"          NumberOfCarsOwned,",
				"          HomeOwnerFlag,",
				"          Married,",
				"          NumberOfChildren,",
				"          InsertedDate,",
				"          ActiveFlag = iscurrent",
				"     ),",
				"     partitionBy('roundRobin', 4)) ~> InsertNewRow",
				"ArchiveCustomerRec sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CustomerPK as integer,",
				"          AccountNumber as integer,",
				"          FirstName as string,",
				"          MiddleInitial as string,",
				"          LastName as string,",
				"          Address as string,",
				"          City as string,",
				"          State as string,",
				"          ZipCode as string,",
				"          NumberOfCarsOwned as integer,",
				"          HomeOwnerFlag as string,",
				"          Married as string,",
				"          NumberOfChildren as integer,",
				"          InsertedDate as timestamp,",
				"          UpdatedDate as timestamp,",
				"          ActiveFlag as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:true,",
				"     upsertable:false,",
				"     keys:['AccountNumber'],",
				"     format: 'table',",
				"     staged: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 2,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          AccountNumber,",
				"          UpdatedDate,",
				"          ActiveFlag = iscurrent",
				"     ),",
				"     partitionBy('roundRobin', 4)) ~> ArchiveOldRow",
				"SetAttrsForNew sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CustomerPK as integer,",
				"          AccountNumber as integer,",
				"          FirstName as string,",
				"          MiddleInitial as string,",
				"          LastName as string,",
				"          Address as string,",
				"          City as string,",
				"          State as string,",
				"          ZipCode as string,",
				"          NumberOfCarsOwned as integer,",
				"          HomeOwnerFlag as string,",
				"          Married as string,",
				"          NumberOfChildren as integer,",
				"          InsertedDate as timestamp,",
				"          UpdatedDate as timestamp,",
				"          ActiveFlag as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     staged: true,",
				"     allowCopyCommand: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 1,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          AccountNumber,",
				"          FirstName,",
				"          LastName,",
				"          Address,",
				"          City,",
				"          State,",
				"          ZipCode,",
				"          NumberOfCarsOwned,",
				"          HomeOwnerFlag,",
				"          Married,",
				"          NumberOfChildren,",
				"          InsertedDate,",
				"          ActiveFlag = iscurrent",
				"     )) ~> InsertNewRecs"
			]
		}
	}
}